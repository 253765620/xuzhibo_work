*** Settings ***
Suite Teardown    clear
Test Teardown     Run Keyword If Test Failed    Fatal Error
Library           SerialLibrary
Library           EXP
Library           Power
Library           Collections
Library           CAN
Library	     Txtrwx
*** Test Cases ***
GET_Ready
    ${time1}    get_local_time
    Set Suite Variable    ${time1}
    txtrwx_mid_file_write    开始时间:${time1}
    #serial_confirm_ter_restart    wait_time=80
    #${time3}    get_local_timesss
    #Set Suite Variable    ${time3}

TS05_WIFI
    Pass Execution If    ${WIFI_TEST}==0    此项s不测试
    :FOR    ${I}    INRANGE    1
    \    serial_confirm_ter_restart     40
    \    serial_send    IOT+D1150511+NL.E01.FAC.CFG=${wifi_open}    IOT+D1150511+NL.E01.FAC.CFG=${wifi_open}
    #\    Wait Until Keyword Succeeds    40s    1s    serial_send    FF    G/netlan
    \    ${a}    Wait Until Keyword Succeeds    120s    1s    serial_send    IOT+S1+nl.e01.fac.chk=?    (CESHI)
    \    ${wifi_sigl}    exp_flag_more_query    ${a}    WIFI    4
    \    ${wifi_sigl}    evaluate    abs(${wifi_sigl})
    \    serial_send    IOT+D1150511+NL.E01.FAC.CFG=${wifi_close}    IOT+D1150511+NL.E01.FAC.CFG=${wifi_close}
    \    Run Keyword If    ${wifi_sigl}>60    Fail    信号强度弱
    \    ${time3}    get_local_time
    \    sleep    3s
    #\    txtrwx_write_file    WIFI测试  开始时间  ${time1}
    #\    txtrwx_write_file    WIFI测试  配置时间  ${time2}   IOT+D1150511+NL.E01.FAC.CFG=1,W001,1236547890
    #\    txtrwx_write_file    WIFI测试  结束时间  ${time3}   PASS  此次测试信号强度 ${wifi_sigl}
 
TS03_bsp版本核对
    serial_send    (bsp)pwr-crt    (bsp)
    ${pwr_inf}    serial_send    (bsp)pwr-info    (bsp)pwr inf
    ${spilt_pwr_inf}    exp_str_spilt    ${pwr_inf}    ,
    log    ${spilt_pwr_inf} 		
    ${hw_tbox}    exp_re_serch    hw    ${spilt_pwr_inf}    
    Run keyword If     '${hw_tbox}'=='${hw}'    log    hw校对成功     ELSE    Fail    hw校对失败，实际为${hw_tbox}        
    #log    ${hw}
    ${mcu_tbox}    exp_re_serch    mcu    ${spilt_pwr_inf}
    Run keyword If     '${mcu_tbox}'=='${mcu}'    log    mcu校对成功     ELSE    Fail    mcu校对失败，实际为${mcu_tbox}
    ${sw_tbox}     exp_re_serch   sw    ${spilt_pwr_inf}
    Run keyword If     '${sw_tbox}'=='${sw}'    log    sw校对成功     ELSE    Fail    sw校对失败，实际为${sw_tbox}
    ${wdg_tbox}     exp_re_serch   wdg    ${spilt_pwr_inf}
    Run keyword If     '${wdg_tbox}'=='${wdg}'    log    wdg校对成功     ELSE    Fail    wdg校对失败，实际为${wdg_tbox}
    ${bat_tbox}     exp_re_serch    bat     ${spilt_pwr_inf}
    ${split_bat_tbox}    exp_str_spilt    ${bat_tbox}    | 
    Run keyword If     '${split_bat_tbox[2]}'=='${bat}'    log    bat校对成功     ELSE    Fail    bat校对失败，实际为${split_bat_tbox[2]}
    log    ${split_bat_tbox[0][5:]}
    ${bat_volt}    Evaluate    int(${split_bat_tbox[0][5:]})
    Run keyword If     ${bat_vol}<${bat_volt}    log   bat电压值正常     ELSE    Fail    bat电压值异常；实际为${bat_volt}mv
    log    ${split_bat_tbox[-1]
    Run keyword If     '${split_bat_tbox[-1]}'=='1'    log    bat状态校对成功     ELSE    Fail    bat状态校对失败，实际为${split_bat_tbox[-1]}
    ${pwr_tbox}     exp_re_serch   pwr:    ${spilt_pwr_inf}
    log    ${pwr_tbox}
    ${split_pwr_tbox}    exp_str_spilt    ${pwr_tbox}    |
    ${pwr_type}    Evaluate    int(${split_pwr_tbox[2]})
    Run keyword If     ${pwr_type}!=0    log    非外部供电;实际为${pwr_type}    WARN
    log    ${split_pwr_tbox[0][5:]}
    ${pwr_volt}    Evaluate    int(${split_pwr_tbox[0][5:]})
    Run keyword If    11000<${pwr_volt}<14000    log   pwr电源电压值正常     ELSE    Fail    pwr电源电压值异常；实际为${pwr_volt}mv    
    txtrwx_abox_file_write    bsp版本核对    pass    (bsp)pwr-info    ${pwr_inf}

TS10_查询版本
    serial_confirm_ter_restart     30    
    ${ver}    serial_send    IOT+S1+NATIVE=?    IOT+S1+NATIVE=
    ${return1}   exp_belong    ${ver}    ${branch1}
    ${ver_2}    serial_send    IOT-S1+NATIVE=?    IOT-S1+NATIVE=
    ${return2}   exp_belong    ${ver_2}    ${branch2}
    Run Keyword If    ${return1}!=1 or ${return2}!=1    Fail    版本校验错误实际为${ver};版本校验错误实际为${ver_2}
    txtrwx_abox_file_write    IOT_版本校对    PASS    IOT+S1+NATIVE=?    ${ver};${ver_2}

IOT_型号日期设置
    Pass Execution If    ${DATA_TEST}==0    此项不测试
    :FOR    ${i}    INRANGE    50
    \    ${a}    serial_send    IOT-S1+ai.m.con.st=?    IOT
    \    Exit For Loop If    '${a}'=='1'
    \    sleep    1
    Run Keyword If    ${i}==49    Fail   串口状态连接失败
    serial_confirm_ter_restart    wait_time=20
    ${m}    serial_send    IOT+D1150511+N.MD=${Equipment_type}    IOT+D1150511+N.MD=
    txtrwx_mid_file_write    s:IOT+D1150511+N.MD=${Equipment_type}    r:IOT+D1150511+N.MD=${m}
    ${a}    serial_send    IOT+D1+N.MD=?    IOT
    Run Keyword If    '${a}'!='${Equipment_type}'   Fail      型号设置失败
    ${n}    serial_send    IOT+D1150511+N.P.D=${date}    IOT+D1150511+N.P.D
    txtrwx_mid_file_write    s:IOT+D1150511+N.P.D=${date}    r:IOT+D1150511+N.P.D=${n}
    ${b}    serial_send    IOT+D1+N.P.D=?   IOT
    Run Keyword If    '${b}'!='${date}'   Fail      日期设置失败

IOT_PID设置
    Pass Execution If    ${PID_TEST}==0    此项不测试
    ${is_have_pid}    serial send    IOT-D1+N.SN=?    IOT-D3    #PID查询
    ${lenpid}    exp_length    ${is_have_pid}
    Run Keyword If    ${lenpid}>1    Fail    PID不为空    #PID查询结果是否为空
    ${IMEI_}    serial_send    IOT+D1+nw.e01.inf=?    IOT   
    ${IMEI}    exp_serial_str_spilt    ${IMEI_}   1
    ${IMEI}    evaluate    '${IMEI[0]}'
    txtrwx_mid_file_write    s:IOT+D1+nw.e01.inf=?    r:IOT+D1+nw.e01.inf=${IMEI_}
    sleep    1
    ${ICCID_}    serial_send    IOT+L1+nw.e01.r01.ic=?    IOT
    txtrwx_mid_file_write    s:IOT+L1+nw.e01.r01.ic=?    r:IOT+L1+nw.e01.r01.ic=${ICCID_}
    ${sim}    Set Variable    ${ICCID_SIM['${ICCID_}']}
    sleep    1
    ${d}    serial send    IOT+D1150511+nw.e01.r01.sim=${sim}    IOT
    txtrwx_mid_file_write    s:IOT+D1150511+nw.e01.r01.sim=${sim}    IOT+D1150511+nw.e01.r01.sim=${d}
    sleep    1
    Run Keyword If    '${sim}'!='${d}'    fail    sim查询错误
    ${pid_zhong}    serial send    IOT+D1150511+N.SN=${pid_start}    IOT+D1150511+N.SN=${pid_start}
    txtrwx_mid_file_write    s:IOT+D1150511+N.SN=${pid_start}    IOT+D1150511+N.SN=${pid_zhong}    
    sleep    1
    ${pid_zhongji}    serial send    IOT+D1+N.SN=?    IOT+D3+N.SN=${pid_start}    #PID查询
    ${date_}    serial_send    IOT+D1+N.P.D=?    IOT 	
    ${tdid}    exp_generate_id    t    d    ${date}    ${pid_start}
    ${tcid}    exp_generate_id    t    c    ${date}    ${pid_start}
    ${adid}    exp_generate_id    a    d    ${date}    ${pid_start}
    ${acid}    exp_generate_id    a    c    ${date}    ${pid_start}
    ${tdid_zhongji}    serial_send    IOT+D1+T3.F1.DIDE=?    IOT+D3+T3.F1.DIDE=${tdid}
    ${tcid_zhongji}    serial_send    IOT+D1+T3.F1.ID=?    IOT+D3+T3.F1.ID=${tcid}
    :FOR    ${i}    inrange    5
    \    serial_send    IOT-V1+ai.m.info.req=    IOT-V1+AI.M.INFO.REQ=successful
    \    sleep    5
    \    ${y}    serial_send    IOT-D1+ai.m.dev.id=?    IOT-D3
    \    ${z}    serial_send    IOT-D1+ai.m.cli.id=?    IOT-D3
    \    Exit For Loop If    '${adid}'=='${y}' and '${acid}'=='${z}'
    Run Keyword If    ${i}==19    Fail    adid fail
    #Run Keyword If    ${i}==4    txtrwx_setid_file_write    abox not id
    :FOR    ${I}    INRANGE    10
    \    ${x}    Run Keyword And Return Status    serial_send    IOT+L1+P.CH.FLH.CD=1    IOT+L1+P.CH.FLH.CD=DONE;
    \    Exit For Loop If    ${x}==True
    \    sleep    1
    Run Keyword If    ${i}==9    Fail    ERROR
    :FOR    ${i}    INRANGE    5
    \    serial_send    IOT-V1+ai.app.st=1    IOT-V1+AI.APP.ST=successful
    \    sleep    2
    \    ${a}    serial_send    IOT-S1+ai.m.app.ack=?    IOT
    \    Exit For Loop If    '${a}'=='1'
    Run Keyword If    ${i}==4    Fail    切换程序失败
    #Run Keyword If    ${i}==4    txtrwx_setid_file_write    qiehuan shibai
    txtrwx_pid_set    ${pid_start}
    txtrwx_setid_file_write    ${ICCID_}
    txtrwx_setid_file_write    ${IMEI}
    txtrwx_setid_file_write    ${d}
    txtrwx_setid_file_write    ${pid_zhongji}
    txtrwx_setid_file_write    ${tdid_zhongji}
    txtrwx_setid_file_write    ${y}    \n
    txtrwx_mid_file_write    IOT_PID设置    PASS    IOT+D1+nw.e01.inf=?    ${IMEI_}    IOT+L1+nw.e01.r01.ic=?    ${ICCID_}    IOT+D1150511+nw.e01.r01.sim=${sim}    ${sim}    IOT+D1150511+N.SN=?    ${pid_start}

GET_END
    ${ICCID_}    serial_send    IOT+L1+nw.e01.r01.ic=?    IOT
    ${time2}    get_local_time
    #${time3}    round_int    ${time1}    ${time2}
    txtrwx_mid_file_write    结束时间:${time2}
    txtrwx_mid_file_write    ${ICCID_}
    txtrwx_mid_file_write    ***************************************************************************************
    txtrwx_transfer    /home/pi/production/mid.txt    /home/pi/production/log/整机测试日志.txt
    txtrwx_delet    /home/pi/production/mid.txt


*** Keywords ***
clear
    txtrwx_delet    /home/pi/production/mid.txt
    serial_send    IOT+D1150511+NL.E01.FAC.CFG=${wifi_close}    IOT+D1150511+NL.E01.FAC.CFG=${wifi_close}
    serial_send     IOT+S1+SHUTDOWN=1    IOT
    sleep    5
    power_KL30_close
    power_KL15_close
    
